<!DOCTYPE html>
<html>
<head>
<title>抽奖 | Alipay-sh
</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<link rel="stylesheet" href="static/style.css">
<link rel="stylesheet" href="static/paperscript.css">
<script src="static/bootstrap.js"></script>
<script src="static/paper.js"></script>
</head>
<body class="fullscreen">
	<div id="main">
		<div id="content">

<script type="text/paperscript" canvas="canvas-1">
//false: stop; true: active;
var state = true;
//false: disable; true: enable; 
var chou = false;
var balls = [];
var group = new Group();

var Ball = Base.extend({
	initialize: function(point, vector, name) {
		if (!vector || vector.isZero()) {
			this.vector = Point.random() * 5;
		} else {
			this.vector = vector * 2;
		}
		this.point = point;
		this.dampen = 0.4;
		//this.gravity = 3;
		this.gravity = 15 - view.size._height / 100 * 1.4;
		this.bounce = -0.6;
		// 大小
		//this.radius = 50 * Math.random() + 30;
		this.radius = 50 * 0.2 + 10;
		this.createPaths();
		this.item.name = name;
		group.addChild(this.item);
	},

	createPaths: function() {
		var overlayPos = this.point + this.radius / 8;
		var compound = new CompoundPath([
			new Path.Circle(this.point, this.radius),
			new Path.Circle(overlayPos, this.radius / 2)
		]);
		var color = new HsbColor(Math.random() * 360, 0.9, 1);
		var gradient = new Gradient([color, 'black'], 'radial');
		compound.children[0].fillColor = new GradientColor(gradient, this.point,
				this.point + this.radius, overlayPos);
		var overlay = new Path.Circle(overlayPos, this.radius / 2);
		var overlayColor = color.clone();
		var fullOverlay = color.clone();
		overlayColor.alpha = 0.3;
		var overlayGradient = new Gradient([new RgbColor(1, 1, 1, 0.5), new RgbColor(1, 1, 1, 1)]);
		overlay.fillColor = new GradientColor(overlayGradient, overlayPos, overlayPos + this.radius / 2);
		this.item = new Group([compound, overlay]);
	},

	iterate: function(i) {
		if (this.item.visible == false) return false;
		var size = view.size, isTarget = false;
		this.vector.y += this.gravity;
		this.vector.x *= 0.99;
		var pre = this.point + this.vector;
		if (pre.x < this.radius || pre.x > size.width - this.radius)
			this.vector.x *= -this.dampen; 
		if (pre.y < this.radius || pre.y > size.height - this.radius) {
			if (Math.abs(this.vector.x) < 3)
				this.vector = Point.random() * [150, 100] + [-75, 20];
			this.vector.y *= this.bounce;
		}

		var max = Point.max(this.radius, this.point + this.vector);
		this.item.position = this.point = Point.min(max, size - this.radius);
		this.item.rotate(this.vector.x / 2);
		if (chou) {
			isTarget = this.checkTarget(this.item);
		}
		if (isTarget) {
			state = !state;
			this.item.visible = false;
			textWinner.content += this.item.name;
			textWinner.content += ' ';
			alert(this.item.name + '中奖啦!');
		}
	},

	checkTarget: function(item){
		var target = {
			left: $('#target').$.offsetLeft,
			top: 0,
			right: $('#target').$.offsetLeft + 300,
			bottom: 40
		};
		if (item.position.y < target.bottom && target.left <= item.position.x && item.position.x <= target.right) {
			return true;
		}
		return false;
	}
});

for (var i = 0; i < 100; i++) {
	var position = Point.random() * (view.size / [1, 2]),
		vector = (Point.random() - [0.5, 0]) * [50, 100];
	var ball = new Ball(position, vector, '樵苏'+i);
	balls.push(ball);
}

console.log(group);

var textItem = new PointText(20, 30);
textItem.fillColor = 'black';
textItem.content = 'Press "space" to stop or continue.'

var textWinner = new PointText(20, 60);
textWinner.fillColor = 'black';
textWinner.content = 'Winner: '

var lastDelta;
function onMouseDrag(event) {
	lastDelta = event.delta;
}

/*
function onMouseUp(event) {
	var ball = new Ball(event.point, lastDelta);
	balls.push(ball);
	lastDelta = null;
}
*/

function onFrame() {
	if (state == true){
		for (var i = 0, l = balls.length; i < l; i++)
			balls[i].iterate(i);
	}
}

function createTargetBoxAndShow(){
	var _dom = document.createElement('div');
	_dom.id = 'target';
	_dom.innerText = '兑奖区';
	$('#content').$.appendChild(_dom);
}

(function(){
	var _t = setTimeout(function(){
		createTargetBoxAndShow();
		chou = true;
	}, 3000);

	$(document).addEvent('keyup', function(e){
		if (e.code == 32) {
			state = !state;
		}
	})

	DomEvent.add(window, {
		resize: function(event) {
			balls.each(function(item, i){
				item.gravity = 15 - view.size._height / 100 * 1.4;
			});
		}
	});
})();



</script>

<div class="canvas">
	<canvas resize="true" id="canvas-1" style="background:#f2f2f2"></canvas>
</div>
		</div>
	</div>
</body>
</html>